#!/bin/bash

# Pre-commit hook to ensure tests pass before committing
# To use this hook, copy it to .git/hooks/pre-commit and make it executable

echo "Running pre-commit tests..."

# Check if we're in the frontend directory or have frontend changes
if git diff --cached --name-only | grep -q "^frontend/"; then
    echo "Frontend changes detected. Running frontend tests..."
    cd frontend
    if [ -f "package.json" ]; then
        # Check if test script exists
        if npm run | grep -q " test"; then
            npm test
            FRONTEND_TEST_RESULT=$?
            if [ $FRONTEND_TEST_RESULT -ne 0 ]; then
                echo "‚ùå Frontend tests failed! Commit aborted."
                exit 1
            fi
            echo "‚úÖ Frontend tests passed!"
        else
            echo "‚ö†Ô∏è  No test script found in frontend/package.json"
        fi
    fi
    cd ..
fi

# Check if we have worker changes - Updated to cover all workers
for worker_dir in auth-worker recipe-embedding-worker recipe-generation-worker recipe-recommendation-worker user-management-worker recipe-view-worker recipe-save-worker recipe-search-db recipe-scraper clipper crawler; do
    if git diff --cached --name-only | grep -q "^$worker_dir/"; then
        echo "$worker_dir changes detected. Running tests..."
        cd "$worker_dir"
        if [ -f "package.json" ]; then
            # Check if test script exists
            if npm run | grep -q " test"; then
                npm test
                WORKER_TEST_RESULT=$?
                if [ $WORKER_TEST_RESULT -ne 0 ]; then
                    echo "‚ùå $worker_dir tests failed! Commit aborted."
                    exit 1
                fi
                echo "‚úÖ $worker_dir tests passed!"
            else
                echo "‚ö†Ô∏è  No test script found in $worker_dir/package.json"
            fi
        fi
        cd ..
    fi
done

# Check for shared directory changes (shared utilities used by workers)
if git diff --cached --name-only | grep -q "^shared/"; then
    echo "Shared utilities changes detected. Running tests..."
    cd shared
    if [ -f "package.json" ]; then
        # Check if test script exists
        if npm run | grep -q " test"; then
            npm test
            SHARED_TEST_RESULT=$?
            if [ $SHARED_TEST_RESULT -ne 0 ]; then
                echo "‚ùå Shared utilities tests failed! Commit aborted."
                exit 1
            fi
            echo "‚úÖ Shared utilities tests passed!"
        else
            echo "‚ö†Ô∏è  No test script found in shared/package.json"
        fi
    fi
    cd ..
fi

echo "‚úÖ All tests passed! Proceeding with commit..."
echo "üìù Remember to push to a feature branch and then merge to staging!"

exit 0